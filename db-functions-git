#!/hint/bash

if [[ -n ${GITUSER} ]]; then
	setfacl -m u:"${GITUSER}":rwx "${WORKDIR}"
	setfacl -m d:u:"${USER}":rwx "${WORKDIR}"
	setfacl -m d:u:"${GITUSER}":rwx "${WORKDIR}"
fi

# Converts from the PKGBUILD tag to the git repository tag
# Input     1:1.0~0-1
# Output    1-1.0.0-1
conv_tag() {
	local git_tag="$1"
	git_tag="${git_tag/:/-}"
	git_tag="${git_tag//\~/.}"
	printf "%s" "${git_tag}"
}

arch_git() {
	if [[ -z ${GITUSER} ]]; then
		/usr/bin/git "${@}"
	else
		sudo -u "${GITUSER}" -- /usr/bin/git "${@}"
	fi
}


# The SVN version should just check the path is present....
fetch_pkgbuild() {
	local pkgbase="${1}"
	local tag=$(conv_tag "${2}")
	[ -d "$WORKDIR/${pkgbase}" ] || git clone --branch "$tag" --depth 1 "${GITREPOS}/${pkgbase}.git" "$WORKDIR/${pkgbase}"
	git -C "${WORKDIR}/${pkgbase}" verify-tag "$tag"
}


# Source the PKGBUILD from the package's git/svn/whatever repo.
source_pkgbuild() {
	local pkgbase="$1"
	local tag=$(conv_tag ${2})
	. <(cat "${WORKDIR}/${pkgbase}/PKGBUILD" 2>/dev/null || echo false)
}

# Export PKGBUILD resource following the same rules as source_pkgbuild()
export_from_pkgrepo() {
	local pkgbase="$1"
	local tag=$(conv_tag ${2})
	local src="$3"
	local dest="$4"
	
	if [[ ! -e ${dest} ]]; then
		mkdir -p "${dest}"
		arch_git -C "${WORKDIR}/${pkgbase}" archive "$tag" | bsdtar -xf - -C "${dest}"
	fi
}

# Which repo is this package in?
find_repo_for_package() {
	local pkgbase=${1}
	local pkgarch=${2}
	local candidates=("${@:3}")

	local repos=($(arch_git -C "${GITREPO}" ls-files "*/$pkgbase" | awk -F/ '{print $1}' | \
		grep -xFf <(printf "%s\n" "${candidates[@]/%/-${pkgarch}}" "${candidates[@]/%/-any}")))

	if (( ${#repos[@]} > 1 )); then
		die "%s is present in multiple repos (%s)" "${pkgbase}" "${repos[*]}"
	fi
	(( ${#repos[@]} == 1 )) || return $?

	printf '%s\n' "${repos[@]%/}"
}

# Commit changes staged by (successive?) vcs_(re)?move_package runs.
vcs_commit() {
	arch_git -C "${GITREPO}" commit -m "${1}:" 
}


vcs_update_package() {
	local pkgbase="$1"
	local tag="${2}"
	local gittag="$(conv_tag ${2})"
	local dest="$3"
	if [[ ! -e "$GITREPO/${dest}" ]]; then
		die "Repository %s doesn't exist!" "${dest}"
	fi
	echo "$pkgbase $gittag $(git -C "${WORKDIR}/${pkgbase}" rev-list -n 1 "$gittag")" > "$GITREPO/$dest/$pkgbase"
	arch_git -C "${GITREPO}" add "$GITREPO/$dest/$pkgbase" || true
	vcs_commit "updated ${pkgbase}-${tag} in [${dest}]" || true
}

# Write to the VCS in order to track a package moving between different pacman
# repositories.
vcs_move_package() {
	local pkgbase=${1}
	local vcsrepo_from=${GITREPO}/${2}
	local vcsrepo_to=${GITREPO}/${3}
	mkdir -p "${vcsrepo_to}"
	arch_git -C "$GITREPO" mv "$vcsrepo_from/${pkgbase}" "$vcsrepo_to/${pkgbase}"
}

# Write to the VCS in order to track a package being deleted from a pacman
# repository.
vcs_remove_package() {
	local pkgbase=${1}
	local vcsrepo=${GITREPO}/${2}/${pkgbase}

	arch_git -C "$GITREPO" rm "$vcsrepo" 
}

vcs_push(){
	arch_git -C "$GITREPO" push --tags origin master
}
